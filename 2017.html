<!Doctype HTML>
<head>

<meta charset='utf-8'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src='d3v4.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.18.0/d3-annotation.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/1.18.0/d3-annotation.min.css" />
<title>2017 Movie Release</title>

<style type="text/css">

.title {
	font-family: "Roboto", sans-serif;
	text-anchor: middle;
}

svg {
	border: 1px black solid;
}
	
.femaleBar {
	opacity: 0.5;
	fill: steelblue;
	/*fill: rgba(116,160,137,0.4)*/
}

.naBar {
	opacity: 0.2;
	/*fill: #FFDEAD;*/
	/*fill: rgb(250,239,209,0.6)*/
	fill: rgb(99, 65, 90);
}

.maleBar {
	opacity: 0.5;
	fill: maroon;
	/*fill: rgba(248,175,168, 0.8); */
	/*fill: rgba(4,108,154,0.3)*/
}

.movieText {
	font-family: "Roboto", sans-serif;
	font-size: 10px;
	text-anchor: middle;
	alignment-baseline: middle;
}

.tick line {
	stroke: black;
	stroke-dasharray: 4,4;
}

.xaxis path {
	display: none;
}

/* Annotations */


.annotation {
  fill: black;
  font-family: "Roboto", sans-serif;
  font-size: 10px;
  text-anchor: end;
}

.annotation path {
	stroke: black;
}

text.annotation-note-label {
  fill: black;
}

</style>

</head>
<body>
<div id='root'></root>

<script>

d3.json('2017.json', data => {

	data.sort((a,b) => b.Female - a.Female);
	console.log(data);

	const width = 620; // Need a 2:1 ratio
	const height = 1460;
	const margin = {"top": 150, "bottom": 20, "right": 80, "left": 80};

	let yScale = d3.scaleBand().domain(data.map(x => x.movieName)).range([0, height]).paddingInner(0.1).paddingOuter(0);
	let xScale = d3.scaleLinear().domain([0, 20]).range([0, width/2]);

    let svg = d3.select("#root")
	    .append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom);

    // Actual Bars

	let movieBarsFemale = svg.selectAll("movies")
		.data(data).enter()
		.append("rect")
		.attr("x", width/2)
		.attr("y", x => yScale(x.movieName))
		.attr("height", yScale.bandwidth())
		.attr("width", x => xScale(x.Female))
		.attr("class", "bar femaleBar")
        .attr("transform", "translate(" + margin.left + "," + (margin.top) + ")");

	let movieBarsNA = svg.selectAll("movies")
		.data(data).enter()
		.append("rect")
		.attr("x", x => width/2 - xScale(x["N/A"]))
		.attr("y", x => yScale(x.movieName))
		.attr("height", yScale.bandwidth())
		.attr("width", x => xScale(x["N/A"]))
		.attr("class", "bar naBar")
        .attr("transform", "translate(" + margin.left + "," + (margin.top) + ")");

	let movieBarsMale = svg.selectAll("movies")
		.data(data).enter()
		.append("rect")
		.attr("x", x => width/2 - xScale(x["N/A"]) - xScale(x.Male))
		.attr("y", x => yScale(x.movieName))
		.attr("height", yScale.bandwidth())
		.attr("width", x => xScale(x.Male))
		.attr("class", "bar maleBar")
        .attr("transform", "translate(" + margin.left + "," + (margin.top) + ")");

	let movieText = svg.selectAll("movies")
		.data(data).enter()
		.append("text")
		.attr("x", x => width/2)
		.attr("y", x => yScale(x.movieName) + yScale.bandwidth()/2)
		.html(x => x.movieName)
		.attr("class", "movieText")
        .attr("transform", "translate(" + margin.left + "," + (margin.top) + ")");

	// Axes

    svg.append("g")
        .attr("transform", "translate(" + (width / 2 + margin.left) + "," + (margin.top) + ")")
        .attr("class", "xaxis rightxaxis")
        .call(d3.axisTop(xScale).tickPadding(6).ticks(4).tickSize(-(height+1)).tickSizeOuter(0));

	d3.selectAll(".tick:first-of-type line").remove();

    svg.append("g")
        .attr("transform", "translate(" + (margin.left) + "," + (margin.top) + ")")
        .attr("class", "xaxis leftxaxis")
        .call(d3.axisTop(xScale.domain([20, 0])).tickPadding(6).ticks(4).tickSize(-(height+1)).tickSizeOuter(0));

    d3.selectAll(".leftxaxis").selectAll(".tick:last-of-type line").remove();
    


    let g = svg.append('g');
    ["maleBar", "naBar", "femaleBar"].forEach((d,i) => {
	  let legend = g.append("rect")
		.attr("x", i*50)
		.attr("y", 0)
		.attr("height", yScale.bandwidth()*1.2)
		.attr("width", 50)
		.attr("class", d)
        .attr("transform", "translate(" + (margin.left - 75 + (width/2)) + "," + (margin.top/2) + ")");
    });

	["Male", "N/A", "Female"].forEach((d,i) => {
	  let legend = g.append("text")
		.attr("x", i*50 + 25)
		.attr("y", yScale.bandwidth()*1.2/2)
		.attr("class", "movieText")
		.html(d)
        .attr("transform", "translate(" + (margin.left - 75 + (width/2)) + "," + (margin.top/2) + ")");
    });

    g.append("text")
		.attr("x", width/2)
		.attr("y", 0)
		.html("Out of the Top 20 Billed Cast Members")
		.attr("class", "title")
		.attr("font-size", "10px")
		.attr("alignment-baseline", "top")
		.attr("dy", 36)
        .attr("transform", "translate(" + (margin.left) + "," + (margin.top/2) + ")");

    let title = g.append("text")
		.attr("x", width/2)
		.attr("y", 0)
		.html("Major Movies Released in 2017")
		.attr("class", "title")
        .attr("transform", "translate(" + (margin.left) + "," + (margin.top/4) + ")");

    // Annotations

    const type = d3.annotationCallout;
    xScale.domain([0, 20])

	const annotations = [
	{
	  note: {
	    label: "Dunkirk had the most number of men in this group of movies.",
	  },
	  x: xScale(1) + width/2,
	  y: yScale("Dunkirk") + yScale.bandwidth()/2,
	  dy: -20,
	  dx: xScale(7) + 52
	},
	{
	  note: {
	    label: "Spider-Man included a lot of well-known actors and actresses (everyone's gender was known).",
	  },
	  x: xScale(8) + width/2,
	  y: yScale("Spider-Man: Homecoming") + yScale.bandwidth()/2,
	  dy: 45,
	  dx: 52
	},
	{
	  note: {
	    label: 'Below "The Glass Castle" there are at least as many men as women (of the people with known gender).',
	  },
	  x: width/2 - xScale(13),
	  y: yScale("The Glass Castle") + yScale.bandwidth()/2,
	  dy: 0,
	  dx: -45
	}]

	const makeAnnotations = d3.annotation()
	  .editMode(false)
	  .type(type)
	  .annotations(annotations)

	d3.select("svg")
	  .append("g")
	  .attr("class", "annotation-group")
      .attr("transform", "translate(" + (margin.left) + "," + (margin.top) + ")")
	  .call(makeAnnotations)


    // N/A color
    // console.log(d3.interpolateRgb("steelblue", "maroon")(0.5))
    console.log(data.filter(x => x.Female > x.Male));

})

</script>

</body>
</html>